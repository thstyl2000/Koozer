name: Build, Release, and Publish Repository

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'Publish a GitHub release when manually triggered'
        required: true
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'
      release_tag:
        description: 'Tag to use for the release when publishing manually (defaults to add-on version)'
        required: false
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: repository-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release_and_publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read add-on metadata
        id: metadata
        run: |
          python - <<'PY' > /tmp/addon_meta.sh
          import xml.etree.ElementTree as ET
          from pathlib import Path

          root = ET.parse(Path('addon.xml')).getroot()
          print(f"ADDON_ID={root.attrib['id']}")
          PY

          source /tmp/addon_meta.sh

          echo "Addon ID: $ADDON_ID"

          echo "id=$ADDON_ID" >> "$GITHUB_OUTPUT"

      - name: Determine build version
        id: version
        run: |
          RAW_TAG=$(git describe --tags --match "v[0-9]*.[0-9]*.[0-9]*" --abbrev=0 2>/dev/null || true)

          if [[ -n "$RAW_TAG" ]]; then
            BASE_VERSION="${RAW_TAG#v}"
          else
            BASE_VERSION="0.0.0"
          fi

          RELEASE_TAG=""
          REF="${GITHUB_REF:-}"

          if [[ "$REF" == refs/tags/* ]]; then
            RELEASE_TAG="${REF#refs/tags/}"
            BASE_VERSION="${RELEASE_TAG#v}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.publish_release }}" == "yes" ]]; then
            if [[ -n "${{ inputs.release_tag }}" ]]; then
              RELEASE_TAG="${{ inputs.release_tag }}"
              BASE_VERSION="${RELEASE_TAG#v}"
            elif [[ -n "$RAW_TAG" ]]; then
              RELEASE_TAG="$RAW_TAG"
              BASE_VERSION="${RELEASE_TAG#v}"
            else
              RELEASE_TAG="v${BASE_VERSION}"
            fi
          fi

          SUFFIX=""
          if [[ -z "$RELEASE_TAG" ]]; then
            SUFFIX=".dev${{ github.run_number }}"
          fi

          BUILD_VERSION="${BASE_VERSION}${SUFFIX}"

          echo "Base version: $BASE_VERSION"
          echo "Version suffix: ${SUFFIX:-<none>}"
          echo "Build version: $BUILD_VERSION"

          if [[ -n "$RELEASE_TAG" ]]; then
            echo "Release tag: $RELEASE_TAG"
            echo "tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          fi

          echo "base=$BASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "suffix=$SUFFIX" >> "$GITHUB_OUTPUT"
          echo "build=$BUILD_VERSION" >> "$GITHUB_OUTPUT"

      - name: Preflight release checks
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.publish_release == 'yes')
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          if [[ -z "$TAG_NAME" ]]; then
            echo "No release tag provided for publishing"
            exit 1
          fi

          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Release tags must follow vMAJOR.MINOR.PATCH"
            exit 1
          fi

          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Working tree is dirty; aborting release"
            git status --short
            exit 1
          fi

      - name: Determine release tag
        id: release_tag
        run: |
          TAG_NAME="${{ steps.version.outputs.tag || github.ref_name }}"

          echo "Using tag: ${TAG_NAME}"
          echo "tag=${TAG_NAME}" >> "$GITHUB_OUTPUT"

      - name: Set addon.xml version for release build
        if: steps.version.outputs.tag != ''
        env:
          ADDON_VERSION: ${{ steps.version.outputs.base }}
        run: |
          python tools/update_addon_version.py "$ADDON_VERSION"

      - name: Create distributable ZIP
        run: |
          ADDON_ID="${{ steps.metadata.outputs.id }}"
          ADDON_VERSION="${{ steps.version.outputs.build }}"

          mkdir -p build/${ADDON_ID}
          rsync -a ./ build/${ADDON_ID}/ \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'build' \
            --exclude 'tests' \
            --exclude 'requirements-dev.txt' \
            --exclude '*.md'

          cd build
          zip -r "${ADDON_ID}-${ADDON_VERSION}.zip" "${ADDON_ID}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.metadata.outputs.id }}-${{ steps.version.outputs.build }}
          path: build/${{ steps.metadata.outputs.id }}-${{ steps.version.outputs.build }}.zip

      - name: Build repository artifacts
        run: |
          python tools/build_repository.py --version "${{ steps.version.outputs.base }}" --suffix "${{ steps.version.outputs.suffix }}"

      - name: Update addon.xml release version
        if: steps.version.outputs.tag != ''
        env:
          ADDON_VERSION: ${{ steps.version.outputs.base }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git fetch origin "$DEFAULT_BRANCH"
          git checkout "$DEFAULT_BRANCH"

          python tools/update_addon_version.py "$ADDON_VERSION"

          if git diff --quiet addon.xml; then
            echo "addon.xml already at version $ADDON_VERSION"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add addon.xml
          git commit -m "chore: update addon version to $ADDON_VERSION"
          git push origin "$DEFAULT_BRANCH"

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload repository artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/repository

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Publish release asset
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.publish_release == 'yes')
        uses: softprops/action-gh-release@v2
        with:
          files: build/${{ steps.metadata.outputs.id }}-${{ steps.version.outputs.build }}.zip
          tag_name: ${{ steps.release_tag.outputs.tag }}
          name: Koozer ${{ steps.version.outputs.base }}
          overwrite_files: ${{ github.event_name == 'workflow_dispatch' && inputs.publish_release == 'yes' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
