name: Build, Release, and Publish Repository

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'Publish a GitHub release when manually triggered'
        required: true
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'
      release_tag:
        description: 'Tag to use for the release when publishing manually (defaults to add-on version)'
        required: false
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: repository-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release_and_publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read add-on metadata
        id: metadata
        run: |
          python - <<'PY' > /tmp/addon_meta.sh
          import xml.etree.ElementTree as ET
          from pathlib import Path

          root = ET.parse(Path('addon.xml')).getroot()
          print(f"ADDON_ID={root.attrib['id']}")
          print(f"ADDON_VERSION={root.attrib['version']}")
          PY

          source /tmp/addon_meta.sh

          echo "Addon ID: $ADDON_ID"
          echo "Addon Version: $ADDON_VERSION"

          echo "id=$ADDON_ID" >> "$GITHUB_OUTPUT"
          echo "version=$ADDON_VERSION" >> "$GITHUB_OUTPUT"

      - name: Determine release tag
        id: release_tag
        run: |
          TAG_NAME="${{ github.ref_name }}"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.publish_release }}" == "yes" ]]; then
            if [[ -n "${{ inputs.release_tag }}" ]]; then
              TAG_NAME="${{ inputs.release_tag }}"
            else
              TAG_NAME="v${{ steps.metadata.outputs.version }}"
            fi
          fi

          echo "Using tag: ${TAG_NAME}"
          echo "tag=${TAG_NAME}" >> "$GITHUB_OUTPUT"

      - name: Create distributable ZIP
        run: |
          ADDON_ID="${{ steps.metadata.outputs.id }}"
          ADDON_VERSION="${{ steps.metadata.outputs.version }}"

          mkdir -p build/${ADDON_ID}
          rsync -a ./ build/${ADDON_ID}/ \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'build' \
            --exclude 'tests' \
            --exclude 'requirements-dev.txt' \
            --exclude '*.md'

          cd build
          zip -r "${ADDON_ID}-${ADDON_VERSION}.zip" "${ADDON_ID}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.metadata.outputs.id }}-${{ steps.metadata.outputs.version }}
          path: build/${{ steps.metadata.outputs.id }}-${{ steps.metadata.outputs.version }}.zip

      - name: Build repository artifacts
        run: |
          python tools/build_repository.py
        env:
          NIGHTLY_VERSION_SUFFIX: .dev${{ github.run_number }}

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload repository artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/repository

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Publish release asset
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.publish_release == 'yes')
        uses: softprops/action-gh-release@v2
        with:
          files: build/${{ steps.metadata.outputs.id }}-${{ steps.metadata.outputs.version }}.zip
          tag_name: ${{ steps.release_tag.outputs.tag }}
          name: Koozer ${{ steps.metadata.outputs.version }}
          overwrite: ${{ github.event_name == 'workflow_dispatch' && inputs.publish_release == 'yes' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
