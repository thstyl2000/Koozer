name: Build and Publish Repository

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'Publish a GitHub release when manually triggered'
        required: true
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'
      release_tag:
        description: 'Tag to use for the release when publishing manually (defaults to v<addon version>)'
        required: false
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: repository-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dev_publish:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      REPOSITORY_ADDON_VERSION: 1.0.0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read add-on metadata
        id: metadata
        run: |
          python - <<'PY' > /tmp/addon_meta.sh
          import xml.etree.ElementTree as ET
          from pathlib import Path

          root = ET.parse(Path('plugin.audio.koozer/addon.xml')).getroot()
          print(f"ADDON_ID={root.attrib['id']}")
          print(f"ADDON_VERSION={root.attrib['version']}")
          PY

          source /tmp/addon_meta.sh

          echo "Addon ID: $ADDON_ID"
          echo "Addon version: $ADDON_VERSION"

          echo "id=$ADDON_ID" >> "$GITHUB_OUTPUT"
          echo "version=$ADDON_VERSION" >> "$GITHUB_OUTPUT"

      - name: Determine dev build version
        id: version
        run: |
          LATEST_TAG=$(git tag --list \
            "v[0-9]*.[0-9]*.[0-9]*" \
            "v[0-9]*.[0-9]*.[0-9]*-alpha.*" \
            --sort=-v:refname | head -n1 || true)

          if [[ -n "$LATEST_TAG" ]]; then
            BASE_VERSION="${LATEST_TAG#v}"
            BASE_VERSION="${BASE_VERSION%%-alpha.*}"
          else
            BASE_VERSION="${{ steps.metadata.outputs.version }}"
          fi

          if [[ -n "$LATEST_TAG" && "$LATEST_TAG" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)-alpha\.([0-9]+)$ ]]; then
            NEXT_ALPHA=$((BASH_REMATCH[2] + 1))
          else
            NEXT_ALPHA=1
          fi

          BUILD_VERSION="${BASE_VERSION}-alpha.${NEXT_ALPHA}"

          echo "Base version: $BASE_VERSION"
          echo "Build version: $BUILD_VERSION"

          echo "base=$BASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "build=$BUILD_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create distributable ZIP
        env:
          ADDON_ID: ${{ steps.metadata.outputs.id }}
          ADDON_VERSION: ${{ steps.version.outputs.build }}
        run: |
          mkdir -p build/${ADDON_ID}
          rsync -a ./plugin.audio.koozer/ build/${ADDON_ID}/ \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'build' \
            --exclude 'tests' \
            --exclude 'requirements-dev.txt' \
            --exclude '*.md'

          cp plugin.audio.koozer/icon.png "build/${ADDON_ID}/icon.png"
          cp plugin.audio.koozer/fanart.jpg "build/${ADDON_ID}/fanart.jpg"

          python - <<'PY'
          import xml.etree.ElementTree as ET
          from pathlib import Path

          import os

          addon_id = os.environ["ADDON_ID"]
          addon_version = os.environ["ADDON_VERSION"]

          build_dir = Path("build") / addon_id
          addon_xml = build_dir / 'addon.xml'

          tree = ET.parse(addon_xml)
          root = tree.getroot()

          previous_version = root.attrib.get('version')
          root.attrib['version'] = addon_version

          try:
              ET.indent(tree)
          except AttributeError:
              pass

          tree.write(addon_xml, encoding='UTF-8', xml_declaration=True)

          print(f"Updated staged addon.xml version from {previous_version} to {addon_version}")
          PY

          cd build
          zip -r "${ADDON_ID}-${ADDON_VERSION}.zip" "${ADDON_ID}"

      - name: Build dev repository artifacts and add-on
        env:
          ADDON_ID: ${{ steps.metadata.outputs.id }}
          ADDON_VERSION: ${{ steps.version.outputs.build }}
        run: |
          python tools/package_repository_addon.py \
            --addon-zip "build/${ADDON_ID}-${ADDON_VERSION}.zip" \
            --addon-version "${REPOSITORY_ADDON_VERSION}" \
            --repository-source repository.koozer.dev \
            --output build/repository-addon \
            --repository-output build/repository

      - name: Publish dev repository to repo-dev branch
        env:
          TARGET_BRANCH: repo-dev
          TARGET_ROOT: repository-dev
        run: |
          git fetch origin "${TARGET_BRANCH}" || true

          if git show-ref --verify --quiet "refs/remotes/origin/${TARGET_BRANCH}"; then
            git switch -c "${TARGET_BRANCH}" --track "origin/${TARGET_BRANCH}"
          else
            git switch --orphan "${TARGET_BRANCH}"
          fi

          git rm -rf . || true
          rm -rf "${TARGET_ROOT}"
          mkdir -p "${TARGET_ROOT}"
          cp -R build/repository "${TARGET_ROOT}/repository"
          mkdir -p "${TARGET_ROOT}/repository-addon"
          cp -R build/repository-addon/*.zip "${TARGET_ROOT}/repository-addon/"

          git add "${TARGET_ROOT}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --cached --quiet; then
            echo "No dev repository changes to publish."
            exit 0
          fi

          git commit -m "chore: update dev repository feed"
          git push origin "${TARGET_BRANCH}"

  stable_publish:
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    env:
      REPOSITORY_ADDON_VERSION: 1.0.0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read add-on metadata
        id: metadata
        run: |
          python - <<'PY' > /tmp/addon_meta.sh
          import xml.etree.ElementTree as ET
          from pathlib import Path

          root = ET.parse(Path('plugin.audio.koozer/addon.xml')).getroot()
          print(f"ADDON_ID={root.attrib['id']}")
          print(f"ADDON_VERSION={root.attrib['version']}")
          PY

          source /tmp/addon_meta.sh

          echo "Addon ID: $ADDON_ID"
          echo "Addon version: $ADDON_VERSION"

          echo "id=$ADDON_ID" >> "$GITHUB_OUTPUT"
          echo "version=$ADDON_VERSION" >> "$GITHUB_OUTPUT"

      - name: Determine stable build version
        id: version
        run: |
          RELEASE_TAG=""
          BASE_VERSION="${{ steps.metadata.outputs.version }}"

          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            RELEASE_TAG="${GITHUB_REF#refs/tags/}"
            BASE_VERSION="${RELEASE_TAG#v}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.release_tag }}" ]]; then
            RELEASE_TAG="${{ inputs.release_tag }}"
            BASE_VERSION="${RELEASE_TAG#v}"
          fi

          BUILD_VERSION="${BASE_VERSION}"

          echo "Base version: $BASE_VERSION"
          echo "Build version: $BUILD_VERSION"

          if [[ -n "$RELEASE_TAG" ]]; then
            echo "Release tag: $RELEASE_TAG"
            echo "tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          fi

          echo "base=$BASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "build=$BUILD_VERSION" >> "$GITHUB_OUTPUT"

      - name: Preflight release checks
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.publish_release == 'yes')
        run: |
          TAG_NAME="${{ steps.version.outputs.tag }}"
          if [[ -z "$TAG_NAME" ]]; then
            TAG_NAME="v${{ steps.version.outputs.base }}"
          fi

          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Release tags must follow vMAJOR.MINOR.PATCH"
            exit 1
          fi

          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Working tree is dirty; aborting release"
            git status --short
            exit 1
          fi

      - name: Create distributable ZIP
        env:
          ADDON_ID: ${{ steps.metadata.outputs.id }}
          ADDON_VERSION: ${{ steps.version.outputs.build }}
        run: |
          mkdir -p build/${ADDON_ID}
          rsync -a ./plugin.audio.koozer/ build/${ADDON_ID}/ \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'build' \
            --exclude 'tests' \
            --exclude 'requirements-dev.txt' \
            --exclude '*.md'

          cp plugin.audio.koozer/icon.png "build/${ADDON_ID}/icon.png"
          cp plugin.audio.koozer/fanart.jpg "build/${ADDON_ID}/fanart.jpg"

          python - <<'PY'
          import xml.etree.ElementTree as ET
          from pathlib import Path

          import os

          addon_id = os.environ["ADDON_ID"]
          addon_version = os.environ["ADDON_VERSION"]

          build_dir = Path("build") / addon_id
          addon_xml = build_dir / 'addon.xml'

          tree = ET.parse(addon_xml)
          root = tree.getroot()

          previous_version = root.attrib.get('version')
          root.attrib['version'] = addon_version

          try:
              ET.indent(tree)
          except AttributeError:
              pass

          tree.write(addon_xml, encoding='UTF-8', xml_declaration=True)

          print(f"Updated staged addon.xml version from {previous_version} to {addon_version}")
          PY

          cd build
          zip -r "${ADDON_ID}-${ADDON_VERSION}.zip" "${ADDON_ID}"

      - name: Upload add-on ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.metadata.outputs.id }}-${{ steps.version.outputs.build }}.zip
          path: build/${{ steps.metadata.outputs.id }}-${{ steps.version.outputs.build }}.zip

      - name: Build repository artifacts and add-on
        env:
          ADDON_ID: ${{ steps.metadata.outputs.id }}
          ADDON_VERSION: ${{ steps.version.outputs.build }}
        run: |
          python tools/package_repository_addon.py \
            --addon-zip "build/${ADDON_ID}-${ADDON_VERSION}.zip" \
            --addon-version "${REPOSITORY_ADDON_VERSION}" \
            --output build/repository-addon \
            --repository-output build/repository

      - name: Upload repository add-on artifact
        uses: actions/upload-artifact@v4
        with:
          name: repository.koozer-${{ env.REPOSITORY_ADDON_VERSION }}.zip
          path: build/repository-addon/repository.koozer-${{ env.REPOSITORY_ADDON_VERSION }}.zip

      - name: Verify repository output
        env:
          ADDON_ID: ${{ steps.metadata.outputs.id }}
        run: |
          ls -al build/repository
          test -f build/repository/addons.xml
          test -f build/repository/addons.xml.md5
          test -d "build/repository/${ADDON_ID}"
          ls -al "build/repository/${ADDON_ID}"

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload repository artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/repository

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Publish release asset
        if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && inputs.publish_release == 'yes')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/repository-addon/*.zip
          tag_name: ${{ steps.version.outputs.tag || format('v{0}', steps.version.outputs.base) }}
          name: Koozer ${{ steps.version.outputs.base }}
          overwrite_files: ${{ github.event_name == 'workflow_dispatch' && inputs.publish_release == 'yes' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
